<html>
<head>
	<title>Game Table</title>
	<script src="3rd/paperjs/paper.js" type="text/javascript"></script>
	<script src="3rd/jquery/js/jquery-1.8.0.min.js" type="text/javascript"></script>
	<script src="js/util.js" type="text/javascript"></script>
	<script src="js/card.js" type="text/javascript"></script>
	<script src="js/user.js" type="text/javascript"></script>
	<script src="http://localhost:8080/socket.io/socket.io.js"></script>
	<script src="js/communication.js" type="text/javascript"></script>
	<script src="js/gameHall.js" type="text/javascript"></script>
	<script src="js/gameview.js" type="text/javascript"></script>
	<script type="text/javascript">
		/**
		* extension of JSON, type for jQuery
		* AUTHOR: xushengs@gmail.com
		* LICENSE: http://www.opensource.org/licenses/mit-license.php
		* WEBSITE: http://ooboy.net/
		*/
		(function($) {
			// the code of this function is from 
			// http://lucassmith.name/pub/typeof.html
			$.type = function(o) {
				var _toS = Object.prototype.toString;
				var _types = {
					'undefined': 'undefined',
					'number': 'number',
					'boolean': 'boolean',
					'string': 'string',
					'[object Function]': 'function',
					'[object RegExp]': 'regexp',
					'[object Array]': 'array',
					'[object Date]': 'date',
					'[object Error]': 'error'
				};
				return _types[typeof o] || _types[_toS.call(o)] || (o ? 'object' : 'null');
			};
			// the code of these two functions is from mootools
			// http://mootools.net
			var $specialChars = { '\b': '\\b', '\t': '\\t', '\n': '\\n', '\f': '\\f', '\r': '\\r', '"': '\\"', '\\': '\\\\' };
			var $replaceChars = function(chr) {
				return $specialChars[chr] || '\\u00' + Math.floor(chr.charCodeAt() / 16).toString(16) + (chr.charCodeAt() % 16).toString(16);
			};
			$.toJSON = function(o) {
				var s = [];
				switch ($.type(o)) {
					case 'undefined':
						return 'undefined';
						break;
					case 'null':
						return 'null';
						break;
					case 'number':
					case 'boolean':
					case 'date':
					case 'function':
						return o.toString();
						break;
					case 'string':
						return '"' + o.replace(/[\x00-\x1f\\"]/g, $replaceChars) + '"';
						break;
					case 'array':
						for (var i = 0, l = o.length; i < l; i++) {
							s.push($.toJSON(o[i]));
						}
						return '[' + s.join(',') + ']';
						break;
					case 'error':
					case 'object':
						for (var p in o) {
							s.push(p + ':' + $.toJSON(o[p]));
						}
						return '{' + s.join(',') + '}';
						break;
					default:
						return '';
						break;
				}
			};
			$.evalJSON = function(s) {
				if ($.type(s) != 'string' || !s.length) return null;
				return eval('(' + s + ')');
			};
		})(jQuery);

		// create the game hall (with just one table)
		//if (!localStorage.getItem('gameHall')) {
		//if (!localStorage.getItem('gameHall')) {
		//	localStorage.setItem('gameHall', $.toJSON(new GameHall(1, 3)));
		//}
		//// This will mimic storage of the login users on server. I think it will store on the server side eventually.
		//if(!localStorage.getItem('loginUsers')) {
		//	localStorage.setItem('loginUsers', $.toJSON(new Array()));
		//}
		//var loginUsers = $.evalJSON(localStorage.getItem('loginUsers'));
		//var jsonUser = sessionStorage.getItem('loginUser');
		//var curSessionUser = jsonUser ? $.evalJSON(jsonUser) : null;
		//if(!jsonUser) {
		//	var sampleUsers = ['Lori', 'Andre', 'Bruce'];
		//	if(loginUsers.length < sampleUsers.length) {
		//		curSessionUser = new User(sampleUsers[loginUsers.length]);
		//		sessionStorage.setItem('loginUser', $.toJSON(curSessionUser));
		//		loginUsers[loginUsers.length] = curSessionUser;
		//		localStorage.setItem('loginUsers', $.toJSON(loginUsers));
		//	} else {
		//		curSessionUser = loginUsers[0];
		//	}
		//} else {
		//	var existUser = null;
		//	for(var i = 0; i < loginUsers.length; ++i) {
		//		if(loginUsers[i].name == curSessionUser.name) {
		//			existUser = loginUsers[i];
		//			break;
		//		}
		//	}
		//	if(!existUser) {
		//		loginUsers[loginUsers.length] = curSessionUser;
		//		localStorage.setItem('loginUsers', $.toJSON(loginUsers));
		//	}
		//}
		var curLoginUser = '';
		$(window).bind('beforeunload', function() {
			sendUserEnd(curLoginUser);
		//	var loginUsers = $.evalJSON(localStorage.getItem('loginUsers'));
		//	var logoutUser = $.evalJSON(sessionStorage.getItem('loginUser'));
		//	if(loginUsers && loginUsers.length > 0) {
		//		for(var i = 0; i < loginUsers.length; ++i) {
		//			if(loginUsers[i].name == logoutUser.name) {
		//				loginUsers.remove(loginUsers[i]);
		//				break;
		//			}
		//		}
		//		localStorage.setItem('loginUsers', $.toJSON(loginUsers));
		//	}
		});
		function login() {
			while(curLoginUser === '') {
				curLoginUser = prompt('Please enter your name','');
			}
			sendUserLogin(curLoginUser);
		}

		// Use javascript directly, here install paperJS.
		paper.install(window);
		
		// Only executed our code once the DOM is ready.
		$(document).ready(function(){
		
			paper.setup('paper');
			
			var gameview = new GameView(paper);
			
			login();
			gameSession.view = gameview;
			gameview.init();
			
			// Create a simple drawing tool:
			var tool = new Tool();
			tool.onMouseDown = function(event) {
				//Test if any of the objects have been hit, and store the object
				var options = {segments:true, stroke:true, fill: true, tolerance: 5};
				var hitObject = gameview.hitTest(event.point, options);
				gameview.handleMouseDownEvent(hitObject);
			}
			tool.onMouseUp = function(event) {
				if(gameview.hitObject) {
					if(gameview.hitObject instanceof Raster) {
					} else {
						//hitObject.fillColor = 'gray';
						gameview.hitObject.strokeColor = 'yellow';
						gameview.hitObject.strokeWidth = 1;
					}
				}
			}
		});
	</script>
	<style type="text/css">
				body { 
					margin: 0;
					overflow: hidden;
					background-color: #013a65;
					font-family:Helvetica,Arial;
				} 
	</style>
</head>
<body>
	<canvas id="paper" resize></canvas>
	<div id="resContainer"></div>
</body>
</html>